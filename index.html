<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç ‚Äî v2</title>
  <style>
    /* ========== –ë–ê–ó–ê ========== */
    :root{
      --bg:#f7f7f8; --card:#ffffff; --text:#161616; --muted:#6b7280; --line:#e5e7eb;
      --brand:#2563eb; --brand-ink:#fff; --shadow:0 8px 24px rgba(2,6,23,.06);
      --radius:14px;
    }
    .dark:root{ --bg:#0f1113; --card:#121418; --text:#f0f2f5; --muted:#9aa3af; --line:#2a2f37; --shadow:0 8px 24px rgba(0,0,0,.35); --brand:#3b82f6; --brand-ink:#0b1220; }
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); line-height:1.5; }

    /* ========== UI: topbar ========== */
    .topbar{ position:sticky; top:0; z-index:20; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; background:color-mix(in oklab, var(--card) 88%, transparent); border-bottom:1px solid var(--line); backdrop-filter:saturate(120%) blur(6px); }
    .title{ font-weight:700; letter-spacing:.2px; }
    .icon-btn{ display:inline-grid; place-items:center; width:38px; height:38px; border-radius:10px; color:inherit; background:transparent; border:1px solid var(--line); cursor:pointer; }

    /* ========== CARD ========== */
    .container{ max-width:980px; margin:14px auto 80px; padding:16px; background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); }
    .section-title{ margin:10px 0 6px; font-weight:700; }
    .kicker{ font-size:13px; color:var(--muted); }

    /* ========== TABLE ========== */
    .calc-table{ width:100%; border-collapse:collapse; margin-top:8px; }
    .calc-table th,.calc-table td{ border-bottom:1px solid var(--line); padding:10px; vertical-align:middle; }
    .calc-table th{ text-align:left; font-weight:700; }
    .calc-table input[type="number"], .calc-table input[type="text"]{
      width: 84px; text-align:center; padding:10px 12px; border-radius:12px; border:1.5px solid var(--line);
      background:color-mix(in oklab, var(--card) 96%, transparent); color:inherit; font-size:16px;
    }
    .calc-table .price-input{ width: 104px; }
    .sum{ white-space:nowrap; text-align:right; font-variant-numeric:tabular-nums; }

    /* ========== TOTALS ========== */
    .totals{ display:flex; flex-wrap:wrap; align-items:center; gap:12px; justify-content:flex-end; margin-top:10px; }
    .grand{ font-weight:800; font-size:20px; }

    /* ========== ACTIONS ========== */
    .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap; }
    .btn{ appearance:none; border:1.5px solid var(--line); background:var(--card); color:inherit; padding:12px 16px; border-radius:12px; cursor:pointer; box-shadow:var(--shadow); }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{ background:var(--brand); border-color:transparent; color:var(--brand-ink); }

    /* ========== ESTIMATE CARD ========== */
    #estimate{ margin-top:12px; }
    .hidden{ display:none !important; }

    /* ========== FLOATERS ========== */
    .scroll-fab{ position:fixed; left:16px; bottom:90px; width:48px; height:48px; display:grid; place-items:center; font-size:22px; border-radius:999px; background:var(--card); color:inherit; border:1px solid var(--line); box-shadow:var(--shadow); cursor:pointer; }
    footer.site-footer{ position:fixed; left:0; right:0; bottom:0; background:var(--card); border-top:1px solid var(--line); padding:8px 12px; font-size:12px; color:var(--muted); }
    main{ padding-bottom:72px; }

    /* ========== ADAPTIVE ========== */
    @media (max-width: 720px){
      .container{ margin:10px 8px 90px; padding:14px; }
      .calc-table thead{ display:none; }
      .calc-table, .calc-table tbody, .calc-table tr, .calc-table td{ display:block; width:100%; }
      .calc-table tbody tr{ border:1px solid var(--line); border-radius:12px; padding:8px 10px; margin-bottom:10px; }
      .calc-table td{ border:none; display:flex; justify-content:space-between; align-items:center; padding:8px 0; }
      .calc-table td::before{ content: attr(data-label); font-size:13px; color:var(--muted); margin-right:12px; flex:1 1 auto; text-align:left; }
      .calc-table input[type="number"], .calc-table input[type="text"]{ width:70px; }
      .sum{ text-align:right; }
    }
  </style>
</head>
<body>
<main>
  <header class="topbar" role="banner">
    <div class="title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
    <button id="themeToggle" class="icon-btn" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É" title="–¢–µ–º–∞" aria-pressed="false">
      <span aria-hidden="true">üåì</span>
    </button>
  </header>

  <div class="container" role="region" aria-labelledby="h-main">
    <h2 id="h-main" class="section-title">–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h2>
    <table class="calc-table" id="table-main">
      <thead>
        <tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</th><th>–ö–æ–ª-–≤–æ</th><th>–ï–¥. –∏–∑–º.</th><th>–¶–µ–Ω–∞ –µ–¥.</th><th>–°—É–º–º–∞</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2 class="section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h2>
    <table class="calc-table" id="table-extra">
      <thead>
        <tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</th><th>–ö–æ–ª-–≤–æ</th><th>–ï–¥. –∏–∑–º.</th><th>–¶–µ–Ω–∞ –µ–¥.</th><th>–°—É–º–º–∞</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="totals" aria-live="polite">
      <label class="kicker" for="discount-input">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞, %</label>
      <input id="discount-input" type="number" min="0" max="100" step="1" inputmode="decimal" placeholder="%" aria-describedby="disc-help" />
      <div id="disc-help" class="kicker">0‚Äì100</div>
      <div class="grand">–ò—Ç–æ–≥–æ: <span id="grand-total">0</span> ‚ÇΩ</div>
    </div>

    <div id="discount-line" class="kicker hidden" style="text-align:right;">
      –°–∫–∏–¥–∫–∞ <b><span id="discount-pct">0</span>%</b>: ‚àí<b><span id="discount-amount">0</span> ‚ÇΩ</b>. –ò—Ç–æ–≥–æ —Å–æ —Å–∫–∏–¥–∫–æ–π: <b><span id="grand-with-discount">0</span> ‚ÇΩ</b>
    </div>

    <div class="est-meta" style="margin-top:12px;">
      <label for="estimate-address" style="display:block;font-size:14px;margin-bottom:6px;color:var(--muted);">–ê–¥—Ä–µ—Å:</label>
      <input id="estimate-address" type="text" placeholder="–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞" style="width:100%;max-width:600px;" />
    </div>

    <div class="actions">
      <button class="btn" id="btn-copy">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn primary" id="btn-pdf">–°–∫–∞—á–∞—Ç—å PDF</button>
    </div>

    <section id="estimate" class="hidden" aria-labelledby="h-est">
      <h2 id="h-est" class="section-title" style="margin:12px 0 8px">–°–º–µ—Ç–∞</h2>
      <div id="estimate-body" class="kicker">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ.</div>
    </section>
  </div>
</main>

<div id="scrollFab" class="scroll-fab" role="button" aria-label="–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É" title="–í–≤–µ—Ä—Ö">‚Üë</div>
<footer class="site-footer">v2 ‚Ä¢ ¬© –í–∞—à–∏ —É–º–Ω—ã–µ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä—ã</footer>

<script>
  // ========= –£–¢–ò–õ–ò–¢–´ =========
  const fmt = new Intl.NumberFormat('ru-RU');
  const formatMoney = n => fmt.format(n || 0);
  const num = v => {
    if (typeof v === 'number') return v;
    if (v == null) return 0;
    return parseFloat(String(v).replace(/\s|\u00A0/g,'').replace(/—Ä—É–±\.?|‚ÇΩ/ig,'').replace(',', '.')) || 0;
  };

  // ========= –î–ê–ù–ù–´–ï =========
  const MAIN = [
    { name:'–ú–æ–Ω—Ç–∞–∂ –Ω–∞—Å—Ç–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞ 07‚Äì09 BTU', unit:'–∫–æ–º–ø–ª.', price:12000 },
    { name:'–ú–æ–Ω—Ç–∞–∂ –Ω–∞—Å—Ç–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞ 12 BTU', unit:'–∫–æ–º–ø–ª.', price:14000 },
    { name:'–ú–æ–Ω—Ç–∞–∂ –Ω–∞—Å—Ç–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞ 18 BTU', unit:'–∫–æ–º–ø–ª.', price:16000 }
  ];

  const EXTRA = [
    { name:'–ê–≤—Ç–æ–≤—ã—à–∫–∞ (–æ—Ç 3 —á–∞—Å–æ–≤)', unit:'—á.', price:2000 },
    { name:'–î–µ–º–æ–Ω—Ç–∞–∂ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ/–Ω–∞—Ä—É–∂–Ω–æ–≥–æ –±–ª–æ–∫–∞ (–∑–∞ –∫–∞–∂–¥—ã–π)', unit:'–±–ª–æ–∫', price:2000 },
    { name:'–î–µ–º–æ–Ω—Ç–∞–∂ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞ 07‚Äì12', unit:'—à—Ç.', price:3000 },
    { name:'–î–µ–º–æ–Ω—Ç–∞–∂ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞ 18‚Äì24', unit:'—à—Ç.', price:4000 },
    { name:'–î–µ–º–æ–Ω—Ç–∞–∂/–º–æ–Ω—Ç–∞–∂ —Å—Ç–µ–∫–ª–æ–ø–∞–∫–µ—Ç–∞', unit:'—à—Ç.', price:1000 },
    { name:'–î–æ–∑–∞–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞ —Ñ—Ä–µ–æ–Ω–æ–º', unit:'–≥.', price:7, step:100 },
    { name:'–ö–∞–±–µ–ª—å –≥–∏–±–∫–∏–π –ü–í–° 3√ó1,5 –º–º¬≤, –ì–û–°–¢ (—Å –º–æ–Ω—Ç–∞–∂–æ–º —à—Ç–µ–ø—Å–µ–ª—å–Ω–æ–π –≤–∏–ª–∫–∏)', unit:'–º.', price:250 },
    { name:'–ö–∞–±–µ–ª—å-–∫–∞–Ω–∞–ª –ø–æ–¥ –ø—Ä–æ–≤–æ–¥', unit:'–º.', price:500 },
    { name:'–ö–∞–∂–¥—ã–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–µ–∑–¥', unit:'–≤—ã–µ–∑–¥', price:1000 },
    { name:'–ö–æ—Ä–æ–± –î–ö–°', unit:'–ø.–º.', price:1200 },
    { name:'–ú–æ–Ω—Ç–∞–∂ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥—Ä–µ–Ω–∞–∂–∞ –±–µ–∑ –∫–æ—Ä–æ–±–∞', unit:'–ø.–º.', price:150 },
    { name:'–ú–æ–Ω—Ç–∞–∂ –∫–æ—Ä–∑–∏–Ω—ã', unit:'—à—Ç.', price:0, editablePrice:true },
    { name:'–ú–æ–Ω—Ç–∞–∂ –Ω–∞—Ä—É–∂–Ω–æ–≥–æ –±–ª–æ–∫–∞ –Ω–∞ –≤–µ–Ω—Ç–∏–ª–∏—Ä—É–µ–º—ã–π —Ñ–∞—Å–∞–¥', unit:'—É—Å–ª—É–≥–∞', price:3500 },
    { name:'–ü–∞–π–∫–∞ —Ñ—Ä–µ–æ–Ω–æ–≤—ã—Ö —Ç—Ä—É–± (–∑–∞ –∫–∞–∂–¥—É—é)', unit:'–ø–∞–π–∫–∞', price:500 },
    { name:'–ü–æ—Ç–æ–ª–æ–∫ ¬´–ê—Ä–º—Å—Ç—Ä–æ–Ω–≥¬ª (—Ä–∞–∑–±–æ—Ä–∫–∞/—Å–±–æ—Ä–∫–∞)', unit:'—à—Ç.', price:200 },
    { name:'–ü—Ä–æ–±–∏–≤–∫–∞ –¥–æ–ø. –æ—Ç–≤–µ—Ä—Å—Ç–∏—è (–±–µ—Ç–æ–Ω, √ò 52 –º–º)', unit:'–æ—Ç–≤.', price:2000 },
    { name:'–ü—Ä–æ–±–∏–≤–∫–∞ –¥–æ–ø. –æ—Ç–≤–µ—Ä—Å—Ç–∏—è (–ì–ö–õ –∏ —Ç.–ø., √ò –¥–æ 52 –º–º)', unit:'–æ—Ç–≤.', price:500 },
    { name:'–ü—Ä–æ–±–∏–≤–∫–∞ –¥–æ–ø. –æ—Ç–≤–µ—Ä—Å—Ç–∏—è (–∫–∏—Ä–ø–∏—á, √ò 52 –º–º)', unit:'–æ—Ç–≤.', price:1000 },
    { name:'–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–Ω—Ç–∏–≤–∞–Ω–¥–∞–ª—å–Ω–æ–π —Ä–µ—à—ë—Ç–∫–∏', unit:'—à—Ç.', price:3000 },
    { name:'–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∏–º–Ω–µ–≥–æ –∫–æ–º–ø–ª–µ–∫—Ç–∞', unit:'—à—Ç.', price:3000 },
    { name:'–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–º–ø—ã', unit:'—à—Ç.', price:2000 },
    { name:'–ß–∏—Å—Ç–∫–∞ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∏ –Ω–∞—Ä—É–∂–Ω—ã–π –±–ª–æ–∫)', unit:'–∫–æ–º–ø–ª.', price:3000 },
    { name:'–ß–∏—Å—Ç–∫–∞ –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–∞ ‚Äî –ø–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å', unit:'–∫–æ–º–ø–ª.', price:4000 },
    { name:'–®—Ç—Ä–æ–±–∞ –≤ –±–µ—Ç–æ–Ω–µ', unit:'–ø.–º.', price:2500 },
    { name:'–®—Ç—Ä–æ–±–∞ –≤ –∫–∏—Ä–ø–∏—á–µ', unit:'–ø.–º.', price:1500 },
    { name:'–®—Ç—Ä–æ–±–∞ –ø–æ–¥ –¥—Ä–µ–Ω–∞–∂ –≤ –±–µ—Ç–æ–Ω–µ', unit:'–ø.–º.', price:800 },
    { name:'–®—Ç—Ä–æ–±–∞ –ø–æ–¥ –¥—Ä–µ–Ω–∞–∂ –≤ –∫–∏—Ä–ø–∏—á–µ', unit:'–ø.–º.', price:600 },
    { name:'–≠–ª–µ–º–µ–Ω—Ç—ã –∫–æ—Ä–æ–±–∞ –î–ö–°', unit:'—à—Ç.', price:350 }
  ].sort((a,b)=>a.name.localeCompare(b.name,'ru'));

  // –î–ª—è –º–æ–Ω—Ç–∞–∂–µ–π: –¥–æ–ø. —Ç—Ä–∞—Å—Å–∞ –ø–æ BTU
  const EXTRA_MAP = {
    '07-09': { name:'–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç—Ä–∞—Å—Å–∞ (–∑–∞ 1 –º) 07‚Äì09 (BTU)', unit:'–ø.–º.', price:1500 },
    '12':    { name:'–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç—Ä–∞—Å—Å–∞ (–∑–∞ 1 –º) 12 (BTU)',     unit:'–ø.–º.', price:1700 },
    '18':    { name:'–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç—Ä–∞—Å—Å–∞ (–∑–∞ 1 –º) 18 (BTU)',     unit:'–ø.–º.', price:1700 }
  };

  // ========= –†–ï–ù–î–ï–† =========
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  const rowHTML = r => {
    const priceCell = r.editablePrice
      ? `<input type="number" class="price-input" min="0" step="1" value="${num(r.price)}" aria-label="–¶–µ–Ω–∞, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è"> ‚ÇΩ`
      : `${formatMoney(num(r.price))} ‚ÇΩ`;
    const step = r.step ? ` step="${r.step}"` : ' step="1"';
    return `<tr>
      <td data-label="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç">${r.name}</td>
      <td data-label="–ö–æ–ª-–≤–æ"><input type="number" inputmode="numeric" pattern="[0-9]*" min="0"${step} value=""></td>
      <td data-label="–ï–¥. –∏–∑–º.">${r.unit}</td>
      <td class="price" data-label="–¶–µ–Ω–∞ –µ–¥.">${priceCell}</td>
      <td class="sum" data-sum="0" data-label="–°—É–º–º–∞">0 ‚ÇΩ</td>
    </tr>`;
  };

  function buildMainWithExtras(){
    const rows = [];
    for (const m of MAIN){
      rows.push(m);
      if (/BTU/i.test(m.name)){
        const key = m.name.includes('07') ? '07-09' : (m.name.includes('12') ? '12' : '18');
        rows.push(EXTRA_MAP[key]);
      }
    }
    $('#table-main tbody').innerHTML = rows.map(rowHTML).join('');
  }

  function buildTable(id, data){ $(id + ' tbody').innerHTML = data.map(rowHTML).join(''); }

  function readUnitPrice(tr){
    const pi = tr.querySelector('.price-input');
    return pi ? num(pi.value) : num(tr.querySelector('.price')?.textContent);
  }

  function recalcAll(){
    let total = 0;
    $$('#table-main tbody tr, #table-extra tbody tr').forEach(tr => {
      const qty = num(tr.querySelector('input[type="number"]')?.value);
      const price = readUnitPrice(tr);
      const sum = Math.max(0, qty) * Math.max(0, price);
      const cell = tr.querySelector('.sum');
      cell.textContent = formatMoney(sum) + ' ‚ÇΩ';
      cell.dataset.sum = String(sum || 0);
      total += sum || 0;
    });
    $('#grand-total').textContent = formatMoney(total);
    applyDiscount(total);
  }

  function discountPct(){ return Math.min(100, Math.max(0, num($('#discount-input')?.value))); }

  function applyDiscount(total){
    const pct = discountPct();
    const discount = Math.round(total * pct) / 100;
    const withDisc = Math.max(0, total - discount);
    const line = $('#discount-line');
    if (pct > 0){
      line.classList.remove('hidden');
      $('#discount-pct').textContent = fmt.format(pct);
      $('#discount-amount').textContent = formatMoney(discount);
      $('#grand-with-discount').textContent = formatMoney(withDisc);
    } else line.classList.add('hidden');
    return { pct, discount, withDisc };
  }

  function buildEstimate(){
    recalcAll();
    const rows = [];
    $$('#table-main tbody tr, #table-extra tbody tr').forEach(tr => {
      const name = tr.querySelector('td:nth-child(1)')?.textContent.trim();
      const qty  = num(tr.querySelector('input[type="number"]').value);
      const unit = tr.querySelector('td:nth-child(3)')?.textContent.trim();
      const price = readUnitPrice(tr);
      const sum = num(tr.querySelector('.sum')?.textContent);
      if (qty > 0 && sum > 0) rows.push({name, qty, unit, price, sum});
    });

    const wrap = $('#estimate-body');
    if (!rows.length){
      wrap.innerHTML = '<p class="kicker">–ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ. –£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.</p>';
      $('#estimate').classList.remove('hidden');
      return;
    }

    let total = 0;
    const items = rows.map(r => { total += r.sum; return `
      <tr>
        <td>${r.name}</td>
        <td style="text-align:center; white-space:nowrap;">${r.qty} ${r.unit}</td>
        <td style="white-space:nowrap;">${formatMoney(r.price)} ‚ÇΩ</td>
        <td class="sum" style="white-space:nowrap; text-align:right;"><b>${formatMoney(r.sum)} ‚ÇΩ</b></td>
      </tr>`; }).join('');

    const disc = applyDiscount(total);
    const discRow = disc.pct > 0 ? `
      <tr>
        <td colspan="3" style="text-align:right;">–°–∫–∏–¥–∫–∞ ${disc.pct}%</td>
        <td style="white-space:nowrap; text-align:right;">‚àí${formatMoney(disc.discount)} ‚ÇΩ</td>
      </tr>` : '';

    const finalRow = `
      <tr>
        <td colspan="3" style="text-align:right;"><b>${disc.pct > 0 ? '–ò—Ç–æ–≥–æ —Å–æ —Å–∫–∏–¥–∫–æ–π' : '–ò—Ç–æ–≥–æ'}</b></td>
        <td style="white-space:nowrap; text-align:right;"><b>${formatMoney(disc.pct > 0 ? disc.withDisc : total)} ‚ÇΩ</b></td>
      </tr>`;

    wrap.innerHTML = `
      <div class="kicker" style="margin-bottom:8px;">–ê–≤—Ç–æ—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç</div>
      <div style="overflow:auto;">
        <table class="calc-table">
          <thead><tr><th>–ü–æ–∑–∏—Ü–∏—è</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞ –µ–¥.</th><th>–°—É–º–º–∞</th></tr></thead>
          <tbody>${items}${discRow}${finalRow}</tbody>
        </table>
      </div>`;

    $('#estimate').classList.remove('hidden');
  }

  function estimateToText(){
    const wrap = $('#estimate-body'); if (!wrap) return '';
    const table = wrap.querySelector('table'); if (!table) return '';
    const rows = [];
    table.querySelectorAll('tbody tr').forEach(tr => {
      const tds = tr.querySelectorAll('td');
      if (tds.length === 4){ rows.push(`${tds[0].textContent.trim()} ‚Äî ${tds[1].textContent.trim()} √ó ${tds[2].textContent.trim()} = ${tds[3].textContent.trim()}`); }
    });
    const address = $('#estimate-address')?.value?.trim();
    const totalLine = table.querySelector('tbody tr:last-child td:last-child')?.textContent?.trim();
    return (rows.join('\n') + (totalLine ? `\n–ò—Ç–æ–≥–æ: ${totalLine}` : '') + (address ? `\n–ê–¥—Ä–µ—Å: ${address}` : '')).trim();
  }

  function copyEstimate(){
    if (!$('#estimate-body table')) buildEstimate();
    const text = estimateToText();
    if (!text){ flashBtn('#btn-copy','–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'); return; }
    navigator.clipboard?.writeText(text).then(() => flashBtn('#btn-copy','–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ'))
      .catch(() => {
        const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); flashBtn('#btn-copy','–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ');
      });
  }

  function pdfEstimate(){
    if (!$('#estimate-body table')) buildEstimate();
    const wrap = $('#estimate-body'); if (!wrap || !wrap.querySelector('table')) { flashBtn('#btn-pdf','–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'); return; }
    const address = $('#estimate-address')?.value?.trim() || '';
    const title = '–°–º–µ—Ç–∞' + (address ? ' ‚Äî ' + address : '');
    const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>${title}</title>
      <style>
        body{ font-family:Arial, sans-serif; margin:24px; }
        h1{ margin:0 0 10px; font-size:20px; }
        .meta{ font-size:12px; color:#6b7280; margin-bottom:6px; }
        table{ width:100%; border-collapse:collapse; margin-top:6px; }
        th,td{ border-bottom:1px solid #ddd; padding:8px; text-align:left; }
        th{ background:#f5f5f5; }
      </style></head><body>
      <h1>${title}</h1>
      <div class="meta">–î–∞—Ç–∞: ${new Date().toLocaleString('ru-RU')}</div>
      ${address ? `<div class="meta"><b>–ê–¥—Ä–µ—Å:</b> ${address}</div>` : ''}
      ${wrap.innerHTML}
      <script>window.print();<\/script>
    </body></html>`;
    const w = window.open('', '_blank'); if (!w) return; w.document.open(); w.document.write(html); w.document.close();
  }

  function flashBtn(sel, text){
    const el = $(sel); if (!el) return;
    const prev = el.textContent; el.textContent = text; setTimeout(()=>el.textContent = prev, 1400);
  }

  // ========= –¢–ï–ú–ê =========
  function setTheme(mode){
    if (mode === 'dark') document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
    try{ localStorage.setItem('theme', mode); }catch(e){}
    const btn = $('#themeToggle'); if (btn){ const dark = document.documentElement.classList.contains('dark'); btn.setAttribute('aria-pressed', String(dark)); btn.title = dark ? '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞' : '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞'; }
  }
  (function initTheme(){
    let saved=null; try{ saved = localStorage.getItem('theme'); }catch(e){}
    if(saved==='dark') setTheme('dark'); else setTheme('light');
    $('#themeToggle').addEventListener('click', () => setTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark'));
  })();

  // ========= SCROLL FAB =========
  (function initScrollFab(){
    const fab = $('#scrollFab'); if (!fab) return;
    const update = () => {
      const doc = document.documentElement;
      const maxScroll = Math.max(document.body.scrollHeight, doc.scrollHeight) - innerHeight;
      const y = scrollY || doc.scrollTop || 0;
      if (maxScroll < 200) { fab.style.display = 'none'; return; } else { fab.style.display = 'grid'; }
      const pos = y / (maxScroll || 1);
      if (pos < 0.20) { fab.dataset.mode = 'down'; fab.textContent = '‚Üì'; fab.title = '–í–Ω–∏–∑'; fab.setAttribute('aria-label','–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–Ω–∏–∑'); }
      else { fab.dataset.mode = 'up'; fab.textContent = '‚Üë'; fab.title = '–í–≤–µ—Ä—Ö'; fab.setAttribute('aria-label','–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö'); }
    };
    update();
    addEventListener('scroll', update, {passive:true});
    addEventListener('resize', update);
    fab.addEventListener('click', () => {
      if (fab.dataset.mode === 'up') scrollTo({ top:0, behavior:'smooth' });
      else scrollTo({ top: document.documentElement.scrollHeight, behavior:'smooth' });
    });
  })();

  // ========= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =========
  function attachUI(){
    // –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü
    buildMainWithExtras();
    buildTable('#table-extra', EXTRA);

    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞
    document.body.addEventListener('input', e => {
      if (e.target.matches('input[type="number"], .price-input')) recalcAll();
      if (e.target.id === 'discount-input'){ const wasOpen = !!$('#estimate-body table'); recalcAll(); if (wasOpen) buildEstimate(); }
    });

    // –ö–Ω–æ–ø–∫–∏
    $('#btn-copy').addEventListener('click', copyEstimate);
    $('#btn-pdf').addEventListener('click', pdfEstimate);

    // –ü–µ—Ä–≤–∏—á–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç
    recalcAll();
  }

  document.addEventListener('DOMContentLoaded', attachUI);
</script>
</body>
</html>