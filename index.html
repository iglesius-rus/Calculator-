<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Калькулятор работ по сплит‑системам</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <style>
    :root {
      --bg:#0b1220;
      --card:#121a2b;
      --text:#e7ecf6;
      --muted:#a7b0c0;
      --accent:#4fc3f7;
      --line:#22314d;
      --input:#0f1626;
    }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Inter', Arial, sans-serif; }
    .wrap { max-width: 980px; margin: 24px auto 72px; padding: 0 16px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:18px; }
    h1 { margin:0 0 12px; font-size:28px; }
    .grid-head, .row { display:grid; grid-template-columns: 1.4fr .6fr .6fr .8fr .8fr; gap:10px; align-items:center; }
    .grid-head { color:var(--muted); font-size:14px; padding:6px 8px; }
    .row { padding:10px 8px; border-top:1px dashed var(--line); }
    .row:first-of-type { border-top:none; }
    .name { line-height:1.25; }
    input[type="number"] { width:100%; padding:10px 12px; background:var(--input); border:1px solid var(--line); color:var(--text); border-radius:10px; font-size:16px; }
    .unit, .price, .sum { text-align:right; white-space:nowrap; }
    .muted { color:var(--muted); }
    .controls { display:flex; gap:12px; flex-wrap:wrap; margin-top:16px; }
    button { background:#18243b; color:var(--text); border:1px solid var(--line); padding:12px 16px; border-radius:12px; font-size:16px; cursor:pointer; }
    button:active { transform: translateY(1px); }
    .totals { font-size:22px; margin:14px 0 8px; }
    .small { font-size:14px; }
    .two { display:grid; grid-template-columns: 1fr 220px; gap:12px; }
    @media (max-width: 680px) {
      .grid-head, .row { grid-template-columns: 1.2fr .5fr .7fr .7fr .7fr; font-size:14px; }
      .two { grid-template-columns:1fr; }
    }
    input[type="text"], input[type="search"]{ width:100%; padding:10px 12px; background:var(--input); border:1px solid var(--line); color:var(--text); border-radius:10px; font-size:16px; }
    footer { position:fixed; left:0; right:0; bottom:0; background:rgba(11,18,32,.95); border-top:1px solid var(--line); padding:10px 16px; text-align:center; font-size:14px; }
    .brand { color:var(--muted); }
    .accent { color:var(--accent); }
    /* Print styles for PDF */
    @media print {
      footer, .controls, .pwa-tip { display:none !important; }
      body { background:#fff; }
      .card { border:none; }
      .wrap { margin:0; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Работы по монтажу</h1>
      <div class="grid-head">
        <div>Наименование работ</div>
        <div>Кол‑во</div>
        <div class="unit">Ед.</div>
        <div class="price">Цена ед.</div>
        <div class="sum">Сумма</div>
      </div>
      <div id="rows"></div>

      <div class="two" style="margin-top:14px;">
        <div>
          <div class="totals">Итого: <span id="total">0</span> ₽</div>
          <div class="small muted">Персональная скидка снижает итоговую сумму.</div>
        </div>
        <div>
          <label class="small muted">Персональная скидка, %</label>
          <input id="discount" type="number" min="0" max="100" step="1" value="0" />
        </div>
      </div>

      <div style="margin-top:10px;">
        <label class="small muted">Адрес объекта</label>
        <input id="address" type="text" placeholder="г. _______, ул. _______, д. __" />
      </div>

      <div class="controls">
        <button id="calcBtn">Рассчёт</button>
        <button id="copyBtn">Скопировать</button>
        <button id="pdfBtn">Скачать PDF</button>
        <button id="resetBtn" title="Сбросить значения">Сброс</button>
      </div>

      <div class="small pwa-tip muted" style="margin-top:10px;">
        Можно установить как приложение: меню браузера → «На экран» / «Установить приложение». Работает офлайн.
      </div>
    </div>
  </div>

  <footer>
    <span class="brand">© Суперкондиционерщик Вано</span>
    <span class="accent"> • Версия сборки: v032.zip • 17.09.2025</span>
  </footer>

  <script>
    const ITEMS = [
      { name: "Штроба в бетоне", unit: "п.м.", price: 2500 },
      { name: "Штроба в кирпиче", unit: "п.м.", price: 1500 },
      { name: "Штроба под дренаж в бетоне", unit: "п.м.", price: 800 },
      { name: "Штроба под дренаж в кирпиче", unit: "п.м.", price: 600 },
      { name: "Установка помпы", unit: "шт.", price: 0, placeholderPrice: "введите цену" },
      { name: "Пробивка доп. отверстия (ГКЛ и т.п., Ø до 52 мм)", unit: "шт.", price: 0, placeholderPrice: "введите цену" },
      // Новые позиции по просьбе:
      { name: "Короб ДКС", unit: "п.м.", price: 1200 },
      { name: "Элементы короба ДКС", unit: "шт.", price: 0, placeholderPrice: "введите цену" }
    ];

    const rowsEl = document.getElementById('rows');
    const totalEl = document.getElementById('total');
    const discountEl = document.getElementById('discount');

    function money(n) { return (Math.round(n)).toLocaleString('ru-RU'); }

    function makeRow(item, idx) {
      const r = document.createElement('div');
      r.className = 'row';
      r.innerHTML = `
        <div class="name">${item.name}</div>
        <div><input type="number" min="0" step="1" value="0" data-idx="${idx}" class="qty"></div>
        <div class="unit">${item.unit}</div>
        <div class="price">
          ${ item.price ? money(item.price) + " ₽" : `<input type="number" min="0" step="50" placeholder="${item.placeholderPrice||''}" value="${item.price||0}" data-idx="${idx}" class="price-input">` }
        </div>
        <div class="sum" id="sum-${idx}">0 ₽</div>
      `;
      return r;
    }

    function render() {
      rowsEl.innerHTML = '';
      ITEMS.forEach((it, i) => rowsEl.appendChild(makeRow(it, i)));
    }

    function calc() {
      let total = 0;
      document.querySelectorAll('.row').forEach((row, i) => {
        const qty = Number(row.querySelector('.qty').value||0);
        const priceInput = row.querySelector('.price-input');
        const price = priceInput ? Number(priceInput.value||0) : ITEMS[i].price;
        const sum = qty * price;
        total += sum;
        document.getElementById('sum-'+i).textContent = money(sum) + ' ₽';
      });
      const d = Number(discountEl.value||0);
      if (d>0) total = total * (100 - Math.min(100, Math.max(0, d))) / 100;
      totalEl.textContent = money(total);
      return total;
    }

    function toText() {
      const parts = [];
      document.querySelectorAll('.row').forEach((row, i) => {
        const name = ITEMS[i].name;
        const qty = Number(row.querySelector('.qty').value||0);
        const unit = ITEMS[i].unit;
        const priceInput = row.querySelector('.price-input');
        const price = priceInput ? Number(priceInput.value||0) : ITEMS[i].price;
        const sum = qty*price;
        if (qty>0) parts.push(`${name} — ${qty} ${unit} × ${price} ₽ = ${sum} ₽`);
      });
      const d = Number(discountEl.value||0);
      const total = calc();
      const lines = [];
      if (parts.length) lines.push(parts.join('\n'));
      lines.push(`Итого с учётом скидки ${d}%: ${money(total)} ₽`);
      const addr = document.getElementById('address').value.trim();
      if (addr) lines.push(`Адрес: ${addr}`);
      return lines.join('\n');
    }

    // Events
    document.addEventListener('input', (e)=>{ if (e.target.matches('.qty,.price-input,#discount')) calc(); });
    document.getElementById('calcBtn').addEventListener('click', calc);
    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      const txt = toText();
      try { await navigator.clipboard.writeText(txt); alert('Скопировано в буфер обмена'); }
      catch(e) { prompt('Скопируйте вручную:', txt); }
    });
    document.getElementById('pdfBtn').addEventListener('click', ()=>{ window.print(); });
    document.getElementById('resetBtn').addEventListener('click', ()=>{ 
      document.querySelectorAll('.qty').forEach(i=>i.value=0);
      document.querySelectorAll('.price-input').forEach(i=>i.value=0);
      discountEl.value=0; document.getElementById('address').value='';
      calc();
    });

    // Render and initial calc
    render(); calc();

    // PWA
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
  </script>
</body>
</html>
