
function _parseMoney(t){if(!t)return 0;var s=String(t).replace(/[^\d.,-]/g,'').replace(/[ \u00A0]/g,'').replace(/,/,'.');var n=Number(s);return isNaN(n)?0:n;}
function getDiscountPct(){var el=document.getElementById('discount-input');if(!el)return 0;var v=parseFloat(String(el.value).replace(',','.'))||0;return Math.min(100,Math.max(0,v));}
function applyDiscountToTotal(total){var pct=getDiscountPct();var discount=Math.round(total*pct)/100;var final=Math.max(0,total-discount);var line=document.getElementById('discount-line');if(line){if(pct>0){line.style.display='';document.getElementById('discount-pct').textContent=pct;document.getElementById('discount-amount').textContent=discount.toLocaleString('ru-RU');document.getElementById('grand-with-discount').textContent=final.toLocaleString('ru-RU');}else{line.style.display='none';}}return{pct:pct,discount:discount,final:final};}
function strictRecalc(){var total=0;var rows=document.querySelectorAll('#table-main tbody tr,#table-extra tbody tr');for(var i=0;i<rows.length;i++){var tr=rows[i];var qtyEl=tr.querySelector('input[type="number"]');var qty=parseFloat(qtyEl&&qtyEl.value?String(qtyEl.value).replace(',','.'):'0')||0;var priceEl=tr.querySelector('.price-input');var unitPrice=priceEl?(parseFloat(priceEl.value)||0):_parseMoney((tr.querySelector('.price')||{}).textContent||'');var sum=qty*unitPrice;var sumCell=tr.querySelector('.sum');if(sumCell){sumCell.textContent=sum.toLocaleString('ru-RU')+' â‚½';sumCell.dataset.sum=sum;}total+=sum;}document.getElementById('grand-total').textContent=total.toLocaleString('ru-RU');applyDiscountToTotal(total);return total;}
document.addEventListener('DOMContentLoaded',function(){document.querySelectorAll('input[type="number"],.price-input').forEach(function(inp){inp.addEventListener('input',strictRecalc);inp.addEventListener('change',strictRecalc);});strictRecalc();});
